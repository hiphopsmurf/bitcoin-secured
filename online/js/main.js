// Generated by CoffeeScript 1.5.0
var AboutCtrl, AlertCtrl, AppController, ContactCtrl, DialogCtrl, DownloadCtrl, FormCtrl, HomeCtrl, InstructionsCtrl, ModalCtrl, SubmitCtrl, app;

app = angular.module("bitcoinSecured", ['ui.bootstrap']).config([
  '$routeProvider', '$locationProvider', function($routeProvider, $locationProvider) {
    return $routeProvider.when("/", {
      action: "home.default",
      controller: HomeCtrl,
      templateUrl: "home.html"
    }).when("/download", {
      action: "download.default",
      controller: DownloadCtrl,
      templateUrl: "download.html"
    }).when("/about", {
      action: "about.default",
      controller: AboutCtrl,
      templateUrl: "about.html"
    }).when("/instructions", {
      action: "instructions.default",
      controller: InstructionsCtrl,
      templateUrl: "instructions.html"
    }).when("/contact", {
      action: "contact.default",
      controller: ContactCtrl,
      templateUrl: "contact.html"
    });
  }
]);

app.factory("txevent", [
  '$window', function($window) {
    return {
      notify: function(msg) {
        return $window.alert(msg);
      },
      doTrans: function(tx_dest, tx_sec, tx_addr, tx_unspent) {
        var eckey, secret, sendTx, tx;
        secret = $window.Bitcoin.Base58.decode(tx_sec).slice(1, 33);
        eckey = new $window.Bitcoin.ECKey(secret);
        tx = new $window.TX(eckey);
        tx.parseInputs(tx_unspent, tx.getAddress());
        tx.addOutput(tx_dest, 0.1);
        sendTx = tx.construct();
        return console.log($window.Crypto.util.bytesToHex(sendTx.serialize()));
      }
    };
  }
]);

app.directive("qrCode", [
  '$window', function($window) {
    return {
      template: "<div id='qr-code'></div>",
      restrict: 'E',
      scope: {
        localQrMsg: '=myAttr'
      },
      link: function(scope, element, attrs) {
        var el, qr;
        el = angular.element(element);
        return qr = new $window.QRCode(el[0], scope.localQrMsg);
      }
    };
  }
]);

app.controller("AppController", AppController = function($scope, $route, $routeParams) {
  var render;
  $scope.baseurl = 'https://bitcoin-secured.com/server';
  render = function() {
    var isAbout, isContact, isDownload, isHome, isInstructions, renderAction, renderPath;
    if (_.isUndefined($route.current.action)) {
      renderAction = "home.default";
    } else {
      renderAction = $route.current.action;
    }
    console.log("render action is: " + renderAction);
    renderPath = renderAction.split(".");
    console.log("render path is: " + renderPath);
    isHome = renderPath[0] === "home";
    isDownload = renderPath[0] === "download";
    isAbout = renderPath[0] === "about";
    isContact = renderPath[0] === "contact";
    isInstructions = renderPath[0] === "instructions";
    $scope.renderAction = renderAction;
    $scope.renderPath = renderPath;
    $scope.isHome = isHome;
    $scope.isDownload = isDownload;
    $scope.isAbout = isAbout;
    $scope.isContact = isContact;
    return $scope.isInstructions = isInstructions;
  };
  return $scope.$on("$routeChangeSuccess", function($currentRoute, $previousRoute) {
    return render();
  });
});

app.controller("HomeCtrl", HomeCtrl = function($scope, $location, $dialog) {
  $scope.steps = ["Enter Data", "Enter Paste"];
  $scope.selection = $scope.steps[0];
  $scope.getCurrentStepIndex = function() {
    return _.indexOf($scope.steps, $scope.selection);
  };
  $scope.goToStep = function(index) {
    if (!_.isUndefined($scope.steps[index])) {
      return $scope.selection = $scope.steps[index];
    }
  };
  $scope.hasNextStep = function() {
    var nextStep, stepIndex;
    stepIndex = $scope.getCurrentStepIndex();
    nextStep = stepIndex + 1;
    return !_.isUndefined($scope.steps[nextStep]);
  };
  $scope.hasPreviousStep = function() {
    var previousStep, stepIndex;
    stepIndex = $scope.getCurrentStepIndex();
    previousStep = stepIndex - 1;
    return !_.isUndefined($scope.steps[previousStep]);
  };
  $scope.incrementStep = function() {
    var nextStep, stepIndex;
    if ($scope.hasNextStep()) {
      stepIndex = $scope.getCurrentStepIndex();
      nextStep = stepIndex + 1;
      return $scope.selection = $scope.steps[nextStep];
    }
  };
  $scope.decrementStep = function() {
    var previousStep, stepIndex;
    if ($scope.hasPreviousStep()) {
      stepIndex = $scope.getCurrentStepIndex();
      previousStep = stepIndex - 1;
      return $scope.selection = $scope.steps[previousStep];
    }
  };
  $scope.openModal = function() {
    console.log("opening modal");
    return $scope.shouldBeOpen = true;
  };
  $scope.closeModal = function() {
    $scope.closeMsg = "I was closed at: " + new Date();
    return $scope.shouldBeOpen = false;
  };
  return $scope.modalOpts = {
    backdropFade: true,
    dialogFade: true
  };
});

app.controller("DownloadCtrl", DownloadCtrl = function($scope) {
  return $scope.downloads = {};
});

app.controller("AboutCtrl", AboutCtrl = function($scope) {
  return $scope.about = {};
});

app.controller("ContactCtrl", ContactCtrl = function($scope) {
  return $scope.contactctrl = {};
});

app.controller("InstructionsCtrl", InstructionsCtrl = function($scope) {
  return $scope.instructionsctrl = {};
});

app.controller("ModalCtrl", ModalCtrl = function($scope) {});

app.controller("FormCtrl", FormCtrl = function($scope, $http, $dialog) {
  $scope.buttonState = {};
  $scope.buttonState.qrcodestate = "disabled";
  $scope.transaction = {};
  $scope.loadUrl = function() {
    var q, tx;
    q = "/blockchain/unspent?address=" + $scope.transaction.address + "&cors=true";
    tx = {};
    tx.dest = $scope.transaction.recipient;
    tx.addr = $scope.transaction.address;
    tx.amount = $scope.transaction.amount;
    tx.fee = $scope.transaction.fee;
    return $http.get(q).success(function(data, status) {
      $scope.buttonState.qrcodestate = "";
      console.log(data);
      console.log(status);
      tx.unspent = data;
      return $scope.rawtx = JSON.stringify(tx);
    }).error(function(data, status) {
      if (data === "No free outputs to spend") {
        return txevent.alert("No free outputs to spend at this address");
      }
    });
  };
  $scope.processForm = function() {
    console.log("Processing form...");
    return $scope.loadUrl();
  };
  $scope.showQr = function() {
    return $scope.openDialog($scope.rawtx);
  };
  $scope.clearAll = function(e) {
    e.preventDefault();
    $scope.transaction = {};
    return $scope.rawtx = "";
  };
  $scope.openDialog = function(msg) {
    var d, opts, t;
    t = "<div id=\"modal\">\n    <qr-code my-attr=\"msg\"></qr-code>\n</div>";
    opts = {
      template: t,
      dialogClass: "modal qr-modal",
      controller: "DialogCtrl",
      backdrop: true,
      resolve: {
        msg: function() {
          return angular.copy(msg);
        }
      }
    };
    d = $dialog.dialog(opts);
    return d.open().then(function(result) {
      if (result === 'ok') {
        return console.log("Your transaction is ok");
      } else {
        return console.log("Your transaction is cancelled");
      }
    });
  };
  return $scope.openNotice = function(msg) {
    var d, opts, t;
    t = "<div id=\"notice-modal\">\n  <div class=\"modal-header\">\n    <h3>Security Phrase</h3>\n  </div>\n  <div class=\"modal-body\">\n    <p>The phrase below is your security phrase.  The same phrase will be shown to you again when you enter your offline transaction.  If you notice any difference between the two phrases, please abandon the offline signing process.</p>\n    <div>\n      <h3>\"{{msg}}\"</h3>\n    </div>\n  </div>\n  <div class=\"modal-footer\">\n    <button ng-click=\"close(result)\" class=\"btn btn-primary\" >I understand</button>\n  </div>\n</div>";
    opts = {
      template: t,
      dialogClass: "modal notice-modal",
      controller: "DialogCtrl",
      backdrop: true,
      resolve: {
        msg: function() {
          return angular.copy(msg);
        }
      }
    };
    d = $dialog.dialog(opts);
    return d.open().then(function(result) {
      if (result === 'ok') {
        return console.log("Your transaction is ok");
      } else {
        return console.log("Your transaction is cancelled");
      }
    });
  };
});

app.controller("SubmitCtrl", SubmitCtrl = function($scope, $http) {
  $scope.submitTx = function() {
    var config;
    config = {};
    config.url = $scope.baseurl + "/pushtx";
    config.data = JSON.stringify({
      'rawtx': $scope.rawpaste
    });
    config.method = 'POST';
    config.headers = {
      'Accept': 'application/json'
    };
    return $http(config).success(function(data, status) {
      console.log(data);
      console.log(status);
      return alert("Transaction was successful");
    });
  };
  return $scope.clearAll = function(e) {
    e.preventDefault();
    $scope.transaction = {};
    return $scope.rawpaste = "";
  };
});

app.controller("DialogCtrl", DialogCtrl = function($scope, msg, dialog) {
  $scope.close = function(result) {
    return dialog.close(result);
  };
  return $scope.msg = msg;
});

app.controller("AlertCtrl", AlertCtrl = function($scope) {
  $scope.alerts = [
    {
      type: "error",
      msg: "Bitcoin Secured 0.1 is alpha quality software. As such, there is a small but real chance of software error. Please don't use this system until this notice is removed."
    }
  ];
  $scope.addAlert = function(msg) {
    return $scope.alerts.push({
      msg: msg
    });
  };
  return $scope.closeAlert = function(index) {
    return $scope.alerts.splice(index, 1);
  };
});
